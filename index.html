<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="./icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Noise Analyzer</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: #fff; text-align: center; overflow-x: hidden; }
        .screen { display: none; padding: 10px; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .active { display: flex; }
        
        /* „Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥„ÅÆ„Ç®„Ç®„É™„Ç¢ */
        #install-area { width: 100%; max-width: 500px; display: none; margin-bottom: 10px; }
        #pwa-install-btn { 
            width: 100%; padding: 15px; background: #ff9800; color: white; 
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .db-container { margin: 5px 0; }
        #db-value { font-size: 4rem; font-weight: bold; line-height: 1; }
        #db-example { color: #00ff00; font-size: 1.1rem; margin-top: 5px; height: 1.5rem; }
        #avg-value { font-size: 0.9rem; color: #aaa; margin-top: 5px; }

        .canvas-container { 
            width: 100%; max-width: 500px; background: #111; border-radius: 10px; 
            margin: 10px 0; padding: 15px; box-sizing: border-box; position: relative;
        }
        canvas { width: 100% !important; height: auto !important; }

        .flex-row { display: flex; width: 100%; align-items: stretch; gap: 8px; }
        .y-axis-label { width: 35px; font-size: 0.7rem; color: #888; display: flex; flex-direction: column; justify-content: space-between; padding-bottom: 20px; text-align: right; }
        .legend-container { display: flex; flex-direction: row; gap: 4px; padding-bottom: 20px; }
        .legend-bar { width: 12px; min-height: 100px; background: linear-gradient(to top, #0000ff, #00ffff, #00ff00, #ffff00, #ff0000); border-radius: 2px; border: 1px solid #333; }
        .legend-labels { display: flex; flex-direction: column; justify-content: space-between; font-size: 0.65rem; color: #888; height: 100%; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 500px; }
        button { padding: 15px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; color: white; }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-gray { background: #555; }
        h2 { font-size: 1.1rem; margin: 5px 0; color: #aaa; }
    </style>
</head>
<body>

    <div id="main-screen" class="screen active">
        <div id="install-area">
            <button id="pwa-install-btn">üì≤ „Ç¢„Éó„É™„Çí„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†</button>
        </div>

        <h2>[ Noise History ]</h2>
        <div class="db-container">
            <div id="db-value">0.0 dB</div>
            <div id="db-example">Ê∏¨ÂÆöÂæÖÊ©ü‰∏≠</div>
            <div id="avg-value">Âπ≥Âùá: -- dB</div>
        </div>
        <div class="canvas-container">
            <canvas id="historyChart"></canvas>
            <p style="font-size: 0.7rem; color: #555; margin: 0;">Ê®™Ëª∏: ÊôÇÈñì / Á∏¶Ëª∏: dB</p>
        </div>
        <div class="controls">
            <button id="start-btn" class="btn-green">Ê∏¨ÂÆöÈñãÂßã</button>
            <button id="reset-btn" class="btn-red">Âπ≥Âùá„É™„Çª„ÉÉ„Éà</button>
            <button onclick="switchScreen('freq-screen')" class="btn-blue" style="grid-column: span 2;">Âë®Ê≥¢Êï∞Ëß£Êûê„É¢„Éº„Éâ</button>
        </div>
    </div>

    <div id="freq-screen" class="screen">
        <h2>[ FFT & Spectrogram ]</h2>
        <div class="canvas-container">
            <div class="flex-row">
                <div class="y-axis-label"><span>90</span><span>60</span><span>30</span><span>0</span></div>
                <div style="flex:1;">
                    <canvas id="fftCanvas" height="120"></canvas>
                    <div style="display:flex; justify-content: space-between; font-size: 0.7rem; color: #888; margin-top:2px;">
                        <span>0Hz</span><span>5k</span><span>10k</span><span>20kHz</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="canvas-container">
            <div class="flex-row">
                <div class="y-axis-label"><span>20k</span><span>10k</span><span>5k</span><span>Low</span></div>
                <div style="flex:1;">
                    <canvas id="spectrogramCanvas" height="180"></canvas>
                </div>
                <div class="legend-container">
                    <div class="legend-bar"></div>
                    <div class="legend-labels"><span>90+</span><span>60</span><span>30</span><span>0</span></div>
                </div>
            </div>
            <p style="font-size: 0.7rem; color: #555; margin: 5px 0 0 0;">‚Üê ÊôÇÈñì„ÅÆÊµÅ„Çå (dB„Ç´„É©„ÉºË°®Á§∫)</p>
        </div>
        <div class="controls" style="grid-template-columns: 1fr;">
            <button onclick="switchScreen('main-screen')" class="btn-gray">„É°„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã</button>
        </div>
    </div>

    <script>
        let audioContext, analyser, dataArray, stream;
        let isMeasuring = false;
        let totalDb = 0, count = 0;
        let lastHistoryUpdate = 0;

        // --- PWA„Ç§„É≥„Çπ„Éà„Éº„É´„É≠„Ç∏„ÉÉ„ÇØ ---
        let deferredPrompt;
        const installArea = document.getElementById('install-area');
        const installBtn = document.getElementById('pwa-install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installArea.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installArea.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // „Çµ„Éº„Éì„Çπ„ÉØ„Éº„Ç´„ÉºÁôªÈå≤
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(() => console.log('SW registered'));
        }

        // --- Ê∏¨ÂÆö„Ç∞„É©„ÉïË®≠ÂÆö ---
        const historyPoints = 100;
        const ctx = document.getElementById('historyChart').getContext('2d');
        const historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(historyPoints).fill(''),
                datasets: [{ 
                    data: Array(historyPoints).fill(0), 
                    borderColor: '#00ff00', borderWidth: 2, pointRadius: 0,
                    fill: true, backgroundColor: 'rgba(0, 255, 0, 0.1)', tension: 0.2 
                }]
            },
            options: {
                animation: false,
                scales: { y: { min: 20, max: 100, ticks: { color: '#555' } }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });

        const fftCanvas = document.getElementById('fftCanvas');
        const fftCtx = fftCanvas.getContext('2d');
        const specCanvas = document.getElementById('spectrogramCanvas');
        const specCtx = specCanvas.getContext('2d');
        const specTempCanvas = document.createElement('canvas');
        const specTempCtx = specTempCanvas.getContext('2d');

        async function startAudio() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isMeasuring = true;
                document.getElementById('start-btn').innerText = "Ê∏¨ÂÆö‰∏≠...";
                update();
            } catch (err) { alert("„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); }
        }

        function update() {
            if (!isMeasuring) return;
            requestAnimationFrame(update);

            analyser.getByteTimeDomainData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                let v = (dataArray[i] - 128) / 128;
                sum += v * v;
            }
            let rms = Math.sqrt(sum / dataArray.length);
            let db = rms > 0 ? 20 * Math.log10(rms) + 95 : 0;
            if (db < 0) db = 0;

            document.getElementById('db-value').innerText = db.toFixed(1) + " dB";
            document.getElementById('db-example').innerText = getExample(db);
            totalDb += db; count++;
            document.getElementById('avg-value').innerText = `Âπ≥Âùá: ${(totalDb / count).toFixed(1)} dB`;

            let now = Date.now();
            if (now - lastHistoryUpdate > 100) {
                historyChart.data.datasets[0].data.push(db);
                historyChart.data.datasets[0].data.shift();
                historyChart.update('none');
                lastHistoryUpdate = now;
            }
            drawFFTAndSpec();
        }

        function drawFFTAndSpec() {
            const freqData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(freqData);

            fftCtx.fillStyle = '#111';
            fftCtx.fillRect(0, 0, fftCanvas.width, fftCanvas.height);
            const barWidth = fftCanvas.width / freqData.length;
            for (let i = 0; i < freqData.length; i++) {
                const h = (freqData[i] / 255) * fftCanvas.height;
                fftCtx.fillStyle = `hsl(${240 - (freqData[i]/255)*240}, 100%, 50%)`;
                fftCtx.fillRect(i * barWidth, fftCanvas.height - h, barWidth - 1, h);
            }

            if (document.getElementById('freq-screen').classList.contains('active')) {
                specTempCanvas.width = specCanvas.width;
                specTempCanvas.height = specCanvas.height;
                specTempCtx.drawImage(specCanvas, -1, 0);
                specCtx.clearRect(0, 0, specCanvas.width, specCanvas.height);
                specCtx.drawImage(specTempCanvas, 0, 0);

                const sliceH = specCanvas.height / freqData.length;
                for (let i = 0; i < freqData.length; i++) {
                    const val = freqData[i];
                    specCtx.fillStyle = `hsl(${240 - (val / 255) * 240}, 100%, 50%)`;
                    specCtx.fillRect(specCanvas.width - 1, specCanvas.height - (i * sliceH), 1, sliceH);
                }
            }
        }

        function getExample(db) {
            if (db < 40) return "üçÄ Âõ≥Êõ∏È§®„ÉªÈùô„Åã„Å™‰ΩèÂÆÖË°ó";
            if (db < 60) return "üè¢ ÊôÆÈÄö„ÅÆ‰∫ãÂãôÊâÄ„ÉªÈùô„Åã„Å™ÂÆ§ÂÜÖ";
            if (db < 80) return "üöó Ëµ∞Ë°å‰∏≠„ÅÆËªäÂÜÖ„ÉªÈ®í„ÄÖ„Åó„ÅÑË°óÈ†≠";
            if (db < 95) return "üöÉ ÈõªËªä„ÅÆ„Ç¨„Éº„Éâ‰∏ã„Éª„Ç´„É©„Ç™„Ç±ÂÜÖ";
            return "üì¢ Â∑•Â†¥ÂÜÖ„Éª„Åç„Çè„ÇÅ„Å¶„ÅÜ„Çã„Åï„ÅÑ";
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        document.getElementById('start-btn').onclick = () => { if(!isMeasuring) startAudio(); };
        document.getElementById('reset-btn').onclick = () => { totalDb = 0; count = 0; };
    </script>
</body>
</html>

