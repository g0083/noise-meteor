<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Noise Meter</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: #fff; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        .container { width: 90%; max-width: 500px; }
        h1 { font-size: 1.5rem; color: #aaa; }
        
        /* デシベル表示 */
        #db-display { font-size: 5rem; font-weight: bold; margin: 20px 0; transition: color 0.2s; }
        
        /* ゲージの外枠 */
        .meter-bg { width: 100%; height: 30px; background: #333; border-radius: 15px; overflow: hidden; margin-bottom: 30px; }
        /* ゲージの中身 */
        #meter-bar { width: 0%; height: 100%; background: #00ff00; transition: width 0.1s; }
        
        button { width: 100%; padding: 20px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; background: #007bff; color: white; }
        .status { margin-top: 10px; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="container">
        <h1>[ Sound Level Meter ]</h1>
        <div id="db-display">0.0 dB</div>
        
        <div class="meter-bg">
            <div id="meter-bar"></div>
        </div>

        <button id="start-btn">測定開始</button>
        <p class="status" id="status-text">マイクの使用を許可してください</p>
    </div>

    <script>
        // PWAのサービスワーカー登録
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(() => console.log('PWA Ready'));
        }

        const startBtn = document.getElementById('start-btn');
        const dbDisplay = document.getElementById('db-display');
        const meterBar = document.getElementById('meter-bar');
        const statusText = document.getElementById('status-text');

        let audioContext;
        let analyser;
        let dataArray;
        let isMeasuring = false;

        startBtn.onclick = async () => {
            if (isMeasuring) {
                location.reload(); // 簡易的にリロードで停止
                return;
            }

            try {
                // マイクへのアクセス
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                isMeasuring = true;
                startBtn.innerText = "測定停止（リロード）";
                statusText.innerText = "測定中...";
                update();
            } catch (err) {
                alert("マイクの起動に失敗しました: " + err);
            }
        };

        function update() {
            if (!isMeasuring) return;
            requestAnimationFrame(update);

            analyser.getByteTimeDomainData(dataArray);

            // 実効値（RMS）の計算
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                let v = (dataArray[i] - 128) / 128; // -1.0 to 1.0 に正規化
                sum += v * v;
            }
            let rms = Math.sqrt(sum / dataArray.length);

            // デシベル換算（マイク感度調整のため+30程度のオフセットを追加）
            let db = rms > 0 ? 20 * Math.log10(rms) + 90 : 0;
            if (db < 0) db = 0;

            // 表示更新
            dbDisplay.innerText = db.toFixed(1) + " dB";
            meterBar.style.width = Math.min(db, 100) + "%";

            // 色の変化
            if (db > 80) {
                dbDisplay.style.color = "#ff4d4d";
                meterBar.style.background = "#ff4d4d";
            } else if (db > 60) {
                dbDisplay.style.color = "#ffcc00";
                meterBar.style.background = "#ffcc00";
            } else {
                dbDisplay.style.color = "#00ff00";
                meterBar.style.background = "#00ff00";
            }
        }
    </script>
</body>
</html>
